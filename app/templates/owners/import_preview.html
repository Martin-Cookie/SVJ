{% extends "base.html" %}
{% block title %}Náhled importu - SVJ Správa{% endblock %}

{% block content %}
<div class="mb-3">
    <a href="/vlastnici/import" class="text-sm text-gray-500 hover:text-gray-700">&larr; Zpět na import</a>
</div>

<div class="flex items-center justify-between mb-3">
    <div>
        <h1 class="text-xl font-bold text-gray-800">Náhled importu - {{ filename }}</h1>
        <p class="text-xs text-gray-500 mt-0.5">{{ preview.rows_processed }} řádků | {{ preview.owners_count }} vlastníků | {{ preview.units_count }} jednotek</p>
    </div>
    <div class="flex gap-2">
        <form action="/vlastnici/import/potvrdit" method="post">
            <input type="hidden" name="file_path" value="{{ file_path }}">
            <input type="hidden" name="filename" value="{{ filename }}">
            <button type="submit" class="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 text-xs font-medium">Potvrdit a uložit</button>
        </form>
        <a href="/vlastnici/import" class="px-3 py-1.5 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 text-xs font-medium">Zrušit</a>
    </div>
</div>

{% set physical_count = preview.preview_rows | selectattr('owner_type', 'equalto', 'physical') | list | length %}
{% set sjm_count = preview.preview_rows | selectattr('owner_type', 'equalto', 'sjm') | list | length %}
{% set legal_count = preview.preview_rows | selectattr('owner_type', 'equalto', 'legal') | list | length %}
{% set partial_count = preview.preview_rows | selectattr('owner_type', 'equalto', 'partial') | list | length %}

<!-- Filter bubbles -->
<div class="grid grid-cols-6 gap-2 mb-3">
    <a href="#" onclick="filterPreview('all');return false" class="filter-bubble block bg-white rounded-lg shadow p-2 text-center hover:ring-2 hover:ring-gray-300 ring-2 ring-gray-400" data-filter="all">
        <p class="text-lg font-bold text-gray-800">{{ preview.preview_rows|length }}</p>
        <p class="text-xs text-gray-500">Vše</p>
    </a>
    <a href="#" onclick="filterPreview('physical');return false" class="filter-bubble block bg-gray-50 rounded-lg shadow p-2 text-center border border-gray-200 hover:ring-2 hover:ring-gray-300" data-filter="physical">
        <p class="text-lg font-bold text-gray-600">{{ physical_count }}</p>
        <p class="text-xs text-gray-600">Fyzická os.</p>
    </a>
    <a href="#" onclick="filterPreview('sjm');return false" class="filter-bubble block bg-purple-50 rounded-lg shadow p-2 text-center border border-purple-200 hover:ring-2 hover:ring-purple-300" data-filter="sjm">
        <p class="text-lg font-bold text-purple-600">{{ sjm_count }}</p>
        <p class="text-xs text-purple-600">SJM</p>
    </a>
    <a href="#" onclick="filterPreview('legal');return false" class="filter-bubble block bg-blue-50 rounded-lg shadow p-2 text-center border border-blue-200 hover:ring-2 hover:ring-blue-300" data-filter="legal">
        <p class="text-lg font-bold text-blue-600">{{ legal_count }}</p>
        <p class="text-xs text-blue-600">Právnická os.</p>
    </a>
    <a href="#" onclick="filterPreview('partial');return false" class="filter-bubble block bg-orange-50 rounded-lg shadow p-2 text-center border border-orange-200 hover:ring-2 hover:ring-orange-300" data-filter="partial">
        <p class="text-lg font-bold text-orange-600">{{ partial_count }}</p>
        <p class="text-xs text-orange-600">Podíl. spoluvl.</p>
    </a>
    <a href="#" onclick="filterPreview('error');return false" class="filter-bubble block bg-red-50 rounded-lg shadow p-2 text-center border border-red-200 hover:ring-2 hover:ring-red-300" data-filter="error">
        <p class="text-lg font-bold {% if preview.errors %}text-red-600{% else %}text-gray-400{% endif %}">{{ preview.errors|length }}</p>
        <p class="text-xs text-red-600">Chyby</p>
    </a>
</div>

<!-- Errors -->
{% if preview.errors %}
<div id="errors-section" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-3 hidden">
    <h3 class="text-sm font-semibold text-red-800 mb-2">Chyby při parsování:</h3>
    <ul class="text-sm text-red-700 list-disc list-inside">
        {% for error in preview.errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- Preview table -->
<div class="bg-white rounded-lg shadow" style="max-height:calc(100vh - 280px); overflow-y:auto; overflow-x:hidden">
    <table id="preview-table" class="w-full text-xs" style="table-layout:fixed">
        <colgroup>
            <col style="width:5%">
            <col style="width:28%">
            <col style="width:10%">
            <col style="width:9%">
            <col style="width:5%">
            <col style="width:9%">
            <col style="width:10%">
            <col style="width:24%">
        </colgroup>
        <thead class="bg-gray-50 border-b-2 border-gray-300 sticky top-0 z-10">
            <tr>
                <th class="px-2 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-blue-600 select-none" onclick="sortPreview(0,'num')">Řádek <span class="sort-arrow"></span></th>
                <th class="px-2 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-blue-600 select-none" onclick="sortPreview(1,'str')">Jméno <span class="sort-arrow"></span></th>
                <th class="px-2 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-blue-600 select-none" onclick="sortPreview(2,'str')">Typ <span class="sort-arrow"></span></th>
                <th class="px-2 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-blue-600 select-none" onclick="sortPreview(3,'num')">Jednotka <span class="sort-arrow"></span></th>
                <th class="px-2 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-blue-600 select-none" onclick="sortPreview(4,'str')">Sekce <span class="sort-arrow"></span></th>
                <th class="px-2 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-blue-600 select-none" onclick="sortPreview(5,'str')">Vlastnictví <span class="sort-arrow"></span></th>
                <th class="px-2 py-2 text-right font-medium text-gray-500 cursor-pointer hover:text-blue-600 select-none" onclick="sortPreview(6,'num')">Podíl SČD <span class="sort-arrow"></span></th>
                <th class="px-2 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-blue-600 select-none" onclick="sortPreview(7,'str')">Email <span class="sort-arrow"></span></th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
            {% for row in preview.preview_rows %}
            <tr class="hover:bg-gray-50 preview-row" data-type="{{ row.owner_type }}">
                <td class="px-2 py-1.5 text-gray-400">{{ row.row }}</td>
                <td class="px-2 py-1.5 font-medium text-gray-900 overflow-hidden" style="text-overflow:ellipsis;white-space:nowrap" title="{{ row.name }}">{{ row.name }}</td>
                <td class="px-2 py-1.5">
                    {% if row.owner_type == 'sjm' %}
                    <span class="px-2 py-0.5 text-xs font-medium bg-purple-100 text-purple-800 rounded-full">SJM</span>
                    {% elif row.owner_type == 'legal' %}
                    <span class="px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Právnická os.</span>
                    {% elif row.owner_type == 'partial' %}
                    <span class="px-2 py-0.5 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">Podíl. spoluvl.</span>
                    {% else %}
                    <span class="px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">Fyzická os.</span>
                    {% endif %}
                </td>
                <td class="px-2 py-1.5 text-gray-500">{{ row.unit_number }}</td>
                <td class="px-2 py-1.5 text-gray-500">{{ row.section }}</td>
                <td class="px-2 py-1.5 text-gray-500">{{ row.ownership_type_raw }}</td>
                <td class="px-2 py-1.5 text-gray-500 text-right font-mono">{{ "{:,}".format(row.podil_scd).replace(",", " ") }}</td>
                <td class="px-2 py-1.5 text-gray-500 overflow-hidden" style="text-overflow:ellipsis;white-space:nowrap" title="{{ row.email or '' }}">{{ row.email or '—' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mt-2 text-xs text-gray-400" id="visible-count">Zobrazeno: {{ preview.preview_rows|length }} řádků</div>

<script>
var activeFilter = 'all';

function filterPreview(type) {
    activeFilter = type;
    var errSection = document.getElementById('errors-section');

    if (type === 'error') {
        // Show errors section, hide table rows
        if (errSection) errSection.classList.remove('hidden');
        document.querySelectorAll('.preview-row').forEach(function(r) { r.style.display = 'none'; });
    } else {
        if (errSection) errSection.classList.add('hidden');
        var visible = 0;
        document.querySelectorAll('.preview-row').forEach(function(r) {
            var show = type === 'all' || r.dataset.type === type;
            r.style.display = show ? '' : 'none';
            if (show) visible++;
        });
        document.getElementById('visible-count').textContent = 'Zobrazeno: ' + visible + ' řádků';
    }

    // Update bubble highlights
    document.querySelectorAll('.filter-bubble').forEach(function(b) {
        var isActive = b.dataset.filter === type;
        b.classList.toggle('ring-2', isActive);
        if (b.dataset.filter === 'all') {
            b.classList.toggle('ring-gray-400', isActive);
        } else if (b.dataset.filter === 'physical') {
            b.classList.toggle('ring-gray-400', isActive);
        } else if (b.dataset.filter === 'sjm') {
            b.classList.toggle('ring-purple-400', isActive);
        } else if (b.dataset.filter === 'legal') {
            b.classList.toggle('ring-blue-400', isActive);
        } else if (b.dataset.filter === 'partial') {
            b.classList.toggle('ring-orange-400', isActive);
        } else if (b.dataset.filter === 'error') {
            b.classList.toggle('ring-red-400', isActive);
        }
    });
}

var previewSortCol = -1, previewSortAsc = true;
function sortPreview(col, type) {
    var table = document.getElementById('preview-table');
    var tbody = table.querySelector('tbody');
    var rows = Array.from(tbody.querySelectorAll('tr'));
    if (previewSortCol === col) { previewSortAsc = !previewSortAsc; } else { previewSortCol = col; previewSortAsc = true; }
    rows.sort(function(a, b) {
        var aText = a.cells[col].textContent.trim();
        var bText = b.cells[col].textContent.trim();
        if (type === 'num') {
            var aNum = parseInt(aText.replace(/\s/g, '')) || 0;
            var bNum = parseInt(bText.replace(/\s/g, '')) || 0;
            return previewSortAsc ? aNum - bNum : bNum - aNum;
        }
        return previewSortAsc ? aText.localeCompare(bText, 'cs') : bText.localeCompare(aText, 'cs');
    });
    rows.forEach(function(row) { tbody.appendChild(row); });
    table.querySelectorAll('.sort-arrow').forEach(function(s) { s.textContent = ''; });
    var arrow = table.querySelectorAll('thead th')[col].querySelector('.sort-arrow');
    if (arrow) arrow.textContent = previewSortAsc ? ' \u25B2' : ' \u25BC';
    table.querySelectorAll('thead th').forEach(function(th, i) {
        th.classList.toggle('text-blue-600', i === col);
        th.classList.toggle('text-gray-500', i !== col);
    });
}
</script>
{% endblock %}
