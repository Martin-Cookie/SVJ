{% extends "base.html" %}
{% block title %}Vlastníci - SVJ Správa{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-800">Evidence vlastníků</h1>
        <p class="text-sm text-gray-500 mt-1">Přehled všech vlastníků jednotek SVJ</p>
    </div>
    <a href="/vlastnici/import" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
        Importovat z Excelu
    </a>
</div>

<!-- Stats cards -->
{% if stats %}
<div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-2xl font-bold text-gray-800">{{ stats.total_owners }}</p>
        <p class="text-xs text-gray-500 mt-1">Vlastníků celkem</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-2xl font-bold text-green-600">{{ stats.total_units }}</p>
        <p class="text-xs text-gray-500 mt-1">Jednotek</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-2xl font-bold text-purple-600">{{ stats.type_counts.get('sjm', 0) }}</p>
        <p class="text-xs text-gray-500 mt-1">SJM</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-2xl font-bold text-blue-600">{{ stats.type_counts.get('legal', 0) }}</p>
        <p class="text-xs text-gray-500 mt-1">Právnické osoby</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-2xl font-bold text-teal-600">{{ stats.emails_count }}</p>
        <p class="text-xs text-gray-500 mt-1">S emailem</p>
    </div>
</div>
{% endif %}

<!-- Filters -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <input type="hidden" name="sort" value="{{ sort }}">
    <input type="hidden" name="order" value="{{ order }}">
    <div class="flex flex-wrap gap-4">
        <div class="flex-1 min-w-[200px]">
            <label class="block text-xs font-medium text-gray-500 mb-1">Hledat</label>
            <input type="text" name="q" value="{{ q }}" placeholder="Jméno, email, telefon, č. jednotky, RČ, IČ..."
                   hx-get="/vlastnici" hx-trigger="keyup changed delay:300ms"
                   hx-target="#owner-table-body" hx-include="[name='typ'],[name='sekce'],[name='sort'],[name='order']"
                   hx-push-url="true"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
        </div>
        <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">Typ vlastníka</label>
            <select name="typ"
                    hx-get="/vlastnici" hx-trigger="change"
                    hx-target="#owner-table-body" hx-include="[name='q'],[name='sekce'],[name='sort'],[name='order']"
                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                <option value="">Všechny typy</option>
                <option value="physical" {% if owner_type == 'physical' %}selected{% endif %}>Fyzická osoba</option>
                <option value="sjm" {% if owner_type == 'sjm' %}selected{% endif %}>SJM</option>
                <option value="legal" {% if owner_type == 'legal' %}selected{% endif %}>Právnická osoba</option>
                <option value="partial" {% if owner_type == 'partial' %}selected{% endif %}>Podílový spoluvlastník</option>
            </select>
        </div>
        {% if stats and stats.sections %}
        <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">Sekce domu</label>
            <select name="sekce"
                    hx-get="/vlastnici" hx-trigger="change"
                    hx-target="#owner-table-body" hx-include="[name='q'],[name='typ']"
                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                <option value="">Všechny sekce</option>
                {% for s in stats.sections %}
                <option value="{{ s }}" {% if sekce == s %}selected{% endif %}>Sekce {{ s }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </div>
</div>

<!-- Owner table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    {% macro sort_header(label, col, align="left") %}
                    {% set next_order = "desc" if sort == col and order == "asc" else "asc" %}
                    <th class="px-4 py-3 text-{{ align }} text-xs font-medium uppercase tracking-wider
                        {% if sort == col %}text-blue-600{% else %}text-gray-500{% endif %}">
                        <a href="/vlastnici?sort={{ col }}&order={{ next_order }}&q={{ q }}&typ={{ owner_type }}&sekce={{ sekce }}"
                           hx-get="/vlastnici?sort={{ col }}&order={{ next_order }}&q={{ q }}&typ={{ owner_type }}&sekce={{ sekce }}"
                           hx-target="#owner-table-body"
                           hx-push-url="true"
                           class="inline-flex items-center gap-1 cursor-pointer hover:text-blue-600 select-none">
                            {{ label }}
                            {% if sort == col %}
                                {% if order == "asc" %}
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L10 6.414l-3.293 3.293a1 1 0 01-1.414 0z"/></svg>
                                {% else %}
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L10 13.586l3.293-3.293a1 1 0 011.414 0z"/></svg>
                                {% endif %}
                            {% else %}
                            <svg class="w-3 h-3 opacity-30" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                            {% endif %}
                        </a>
                    </th>
                    {% endmacro %}
                    {{ sort_header("Vlastník", "name") }}
                    {{ sort_header("Typ", "type") }}
                    {{ sort_header("Jednotky", "jednotky") }}
                    {{ sort_header("Sekce", "sekce") }}
                    {{ sort_header("Email", "email") }}
                    {{ sort_header("Telefon", "phone") }}
                    {{ sort_header("Podíl SČD", "podil", "right") }}
                </tr>
            </thead>
            <tbody id="owner-table-body" class="divide-y divide-gray-200">
                {% for owner in owners %}
                {% include "partials/owner_row.html" %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if not owners %}
    <div class="p-8 text-center text-gray-500">
        <p>Žádní vlastníci. <a href="/vlastnici/import" class="text-blue-600 hover:underline">Importujte data z Excelu</a>.</p>
    </div>
    {% endif %}
</div>

<div class="mt-4 flex items-center justify-between text-sm text-gray-500">
    <span>Zobrazeno: <strong>{{ owners|length }}</strong> vlastníků</span>
    {% if owners %}
    {% set total_scd = [] %}
    {% for owner in owners %}
        {% for ou in owner.units %}
            {% if total_scd.append(ou.votes) %}{% endif %}
        {% endfor %}
    {% endfor %}
    <span>Celkem podíl SČD: <strong>{{ "{:,}".format(total_scd|sum).replace(",", " ") }}</strong></span>
    {% endif %}
</div>
{% endblock %}
