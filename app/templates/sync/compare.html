{% extends "base.html" %}
{% block title %}Porovnání - {{ session.csv_filename }}{% endblock %}

{% block content %}
<div class="mb-3">
    <a href="/synchronizace" class="text-sm text-gray-500 hover:text-gray-700">&larr; Zpět</a>
</div>

<div class="flex items-center justify-between mb-3">
    <div>
        <h1 class="text-xl font-bold text-gray-800">Porovnání vlastníků</h1>
        <p class="text-xs text-gray-500 mt-0.5">{{ session.csv_filename }} | {{ session.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
    </div>
    <div class="flex gap-2">
        <form action="/synchronizace/{{ session.id }}/aplikovat-kontakty" method="post">
            <button type="submit" class="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 text-xs font-medium">Přenést kontakty</button>
        </form>
        <form action="/synchronizace/{{ session.id }}/exportovat" method="post">
            <button type="submit" class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs font-medium">Export Excel</button>
        </form>
    </div>
</div>

<!-- Stats - clickable filters -->
{% set katastr = 4103391 %}
{% macro podil_tbl(excel, csv) %}
{% set d = excel - csv %}
<table class="text-xs" style="border-spacing:0;border-collapse:collapse;margin:0 auto">
    <tr><td class="text-left text-gray-500 pr-1" style="white-space:nowrap">Ev:</td><td class="text-right font-mono text-gray-800" style="white-space:nowrap">{{ "{:,}".format(excel).replace(",", " ") }}</td></tr>
    <tr><td class="text-left text-gray-400 pr-1" style="white-space:nowrap">CSV:</td><td class="text-right font-mono text-gray-400" style="white-space:nowrap">{{ "{:,}".format(csv).replace(",", " ") }}</td></tr>
    <tr><td class="text-left pr-1 {% if d != 0 %}text-red-500{% else %}text-green-500{% endif %}" style="white-space:nowrap">±</td><td class="text-right font-mono {% if d != 0 %}text-red-500{% else %}text-green-500{% endif %}" style="white-space:nowrap">{{ "{:,}".format(d).replace(",", " ") }}</td></tr>
</table>
{% endmacro %}
<div class="flex flex-wrap gap-1.5 mb-3">
    {% set d_ev = total_excel_podil - total_csv_podil %}
    {% set pct_ev = "%.2f"|format(d_ev / katastr * 100) %}
    {% set d_kat = katastr - total_csv_podil %}
    {% set pct_kat = "%.2f"|format(d_kat / katastr * 100) %}
    <a href="/synchronizace/{{ session.id }}" style="flex:1" class="bg-white rounded-lg shadow px-2 py-1 text-center hover:ring-2 hover:ring-gray-300 {% if not filtr %}ring-2 ring-gray-400{% endif %}">
        <p class="text-sm font-bold text-gray-800">{{ session.total_records }}</p>
        <p class="text-xs text-gray-500">Vše</p>
        <table class="text-xs" style="border-spacing:0;border-collapse:collapse;margin:0 auto">
            <tr><td class="text-left text-gray-500 pr-1" style="white-space:nowrap">Kat:</td><td class="text-right font-mono text-gray-500" style="white-space:nowrap">{{ "{:,}".format(katastr).replace(",", " ") }}</td></tr>
            <tr><td class="text-left text-gray-500 pr-1" style="white-space:nowrap">Ev:</td><td class="text-right font-mono text-gray-800" style="white-space:nowrap">{{ "{:,}".format(total_excel_podil).replace(",", " ") }}</td></tr>
            <tr><td class="text-left text-gray-400 pr-1" style="white-space:nowrap">CSV:</td><td class="text-right font-mono text-gray-400" style="white-space:nowrap">{{ "{:,}".format(total_csv_podil).replace(",", " ") }}</td></tr>
            <tr><td class="text-left pr-1 {% if d_ev != 0 %}text-red-500{% else %}text-green-500{% endif %}" style="white-space:nowrap">± E-C:</td><td class="text-right font-mono {% if d_ev != 0 %}text-red-500{% else %}text-green-500{% endif %}" style="white-space:nowrap">{{ "{:,}".format(d_ev).replace(",", " ") }} {{ pct_ev }}%</td></tr>
            <tr><td class="text-left pr-1 {% if d_kat != 0 %}text-red-500{% else %}text-green-500{% endif %}" style="white-space:nowrap">± K-C:</td><td class="text-right font-mono {% if d_kat != 0 %}text-red-500{% else %}text-green-500{% endif %}" style="white-space:nowrap">{{ "{:,}".format(d_kat).replace(",", " ") }} {{ pct_kat }}%</td></tr>
        </table>
    </a>
    <a href="/synchronizace/{{ session.id }}?filtr=match" style="flex:1" class="bg-green-50 rounded-lg shadow px-2 py-1 text-center border border-green-200 hover:ring-2 hover:ring-green-300 {% if filtr == 'match' %}ring-2 ring-green-400{% endif %}">
        <p class="text-sm font-bold text-green-600">{{ total_full_match or 0 }}</p>
        <p class="text-xs text-green-600">Úplná shoda</p>
        {{ podil_tbl(match_excel, match_csv) }}
    </a>
    <a href="/synchronizace/{{ session.id }}?filtr=partial" style="flex:1" class="bg-green-50 rounded-lg shadow px-2 py-1 text-center border border-green-200 hover:ring-2 hover:ring-green-300 {% if filtr == 'partial' %}ring-2 ring-green-400{% endif %}">
        <p class="text-sm font-bold text-orange-500">{{ total_partial or 0 }}</p>
        <p class="text-xs text-orange-500">Částečná shoda</p>
        {{ podil_tbl(partial_excel, partial_csv) }}
    </a>
    <a href="/synchronizace/{{ session.id }}?filtr=name_order" style="flex:1" class="bg-orange-50 rounded-lg shadow px-2 py-1 text-center border border-orange-200 hover:ring-2 hover:ring-orange-300 {% if filtr == 'name_order' %}ring-2 ring-orange-400{% endif %}">
        <p class="text-sm font-bold text-red-600">{{ session.total_name_order or 0 }}</p>
        <p class="text-xs text-red-600">Přeházená jména</p>
        {{ podil_tbl(name_order_excel, name_order_csv) }}
    </a>
    <a href="/synchronizace/{{ session.id }}?filtr=difference" style="flex:1" class="bg-red-50 rounded-lg shadow px-2 py-1 text-center border border-red-200 hover:ring-2 hover:ring-red-300 {% if filtr == 'difference' %}ring-2 ring-red-400{% endif %}">
        <p class="text-sm font-bold text-red-600">{{ session.total_differences }}</p>
        <p class="text-xs text-red-600">Rozdílní vlastníci</p>
        {{ podil_tbl(diff_excel, diff_csv) }}
    </a>
    {% set pct_e = "%.2f"|format(podil_diff_excel / katastr * 100) %}
    {% set pct_c = "%.2f"|format(podil_diff_csv / katastr * 100) %}
    {% set diff_abs = podil_diff_excel - podil_diff_csv %}
    {% set pct_d = "%.2f"|format(diff_abs / katastr * 100) %}
    <a href="/synchronizace/{{ session.id }}?filtr=podil_diff" style="flex:1" class="bg-red-50 rounded-lg shadow px-2 py-1 text-center border border-red-200 hover:ring-2 hover:ring-red-300 {% if filtr == 'podil_diff' %}ring-2 ring-red-400{% endif %}">
        <p class="text-sm font-bold text-red-600">{{ total_podil_diff or 0 }}</p>
        <p class="text-xs text-red-600">Rozdílné podíly</p>
        <table class="text-xs" style="border-spacing:0;border-collapse:collapse;margin:0 auto">
            <tr><td class="text-left text-gray-500 pr-1" style="white-space:nowrap">Ev:</td><td class="text-right font-mono text-gray-800" style="white-space:nowrap">{{ "{:,}".format(podil_diff_excel).replace(",", " ") }}</td><td class="text-right font-mono text-gray-400 pl-1" style="white-space:nowrap">{{ pct_e }}%</td></tr>
            <tr><td class="text-left text-gray-400 pr-1" style="white-space:nowrap">CSV:</td><td class="text-right font-mono text-gray-400" style="white-space:nowrap">{{ "{:,}".format(podil_diff_csv).replace(",", " ") }}</td><td class="text-right font-mono text-gray-400 pl-1" style="white-space:nowrap">{{ pct_c }}%</td></tr>
            <tr><td class="text-left pr-1 {% if diff_abs != 0 %}text-red-500{% else %}text-green-500{% endif %}" style="white-space:nowrap">±</td><td class="text-right font-mono {% if diff_abs != 0 %}text-red-500{% else %}text-green-500{% endif %}" style="white-space:nowrap">{{ "{:,}".format(diff_abs).replace(",", " ") }}</td><td class="text-right font-mono pl-1 {% if diff_abs != 0 %}text-red-500{% else %}text-green-500{% endif %}" style="white-space:nowrap">{{ pct_d }}%</td></tr>
        </table>
    </a>
    <a href="/synchronizace/{{ session.id }}?filtr=missing" style="flex:1" class="bg-gray-50 rounded-lg shadow px-2 py-1 text-center border border-gray-200 hover:ring-2 hover:ring-gray-300 {% if filtr == 'missing' %}ring-2 ring-gray-400{% endif %}">
        <p class="text-sm font-bold text-gray-600">{{ session.total_missing }}</p>
        <p class="text-xs text-gray-600">Chybí</p>
        {{ podil_tbl(missing_excel, missing_csv) }}
    </a>
</div>

<!-- Update toolbar -->
<form id="sync-update-form" action="/synchronizace/{{ session.id }}/aktualizovat" method="post">
<input type="hidden" name="filtr" value="{{ filtr }}">
<div class="flex items-center gap-3 mb-2 bg-white rounded-lg shadow px-3 py-2">
    <button type="button" id="sync-toggle-btn" onclick="syncToggleAll()" class="px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-xs">Vybrat vše</button>
    <span id="sync-selected-count" class="text-xs text-gray-500">0 polí vybráno</span>
    <button type="submit" id="sync-submit-btn" disabled class="ml-auto px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs font-medium disabled:opacity-40 disabled:cursor-not-allowed">Aktualizovat vybrané</button>
</div>

<!-- Comparison table -->
<div class="bg-white rounded-lg shadow" style="max-height:calc(100vh - 280px); overflow-y:auto; overflow-x:hidden">
    <table class="w-full text-xs" style="table-layout:fixed">
        <colgroup>
            <col style="width:2.5%">
            <col style="width:3.5%">
            <col style="width:2%">
            <col style="width:53.5%">
            <col style="width:6%">
            <col style="width:5%">
            <col style="width:9%">
            <col style="width:5.5%">
            <col style="width:7%">
        </colgroup>
        <thead class="bg-gray-50 border-b-2 border-gray-300 sticky top-0 z-10">
            {% macro sort_th(label, col, align="left") %}
            {% set next_order = "desc" if sort == col and order == "asc" else "asc" %}
            <th class="px-1 py-1.5 text-{{ align }} font-medium {% if sort == col %}text-blue-600{% else %}text-gray-500{% endif %}">
                <a href="/synchronizace/{{ session.id }}?filtr={{ filtr }}&sort={{ col }}&order={{ next_order }}"
                   class="inline-flex items-center gap-0.5 cursor-pointer hover:text-blue-600 select-none">
                    {{ label }}
                    {% if sort == col %}
                        {% if order == "asc" %}
                        <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L10 6.414l-3.293 3.293a1 1 0 01-1.414 0z"/></svg>
                        {% else %}
                        <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 20 20"><path d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L10 13.586l3.293-3.293a1 1 0 011.414 0z"/></svg>
                        {% endif %}
                    {% endif %}
                </a>
            </th>
            {% endmacro %}
            <tr>
                <th class="px-0 py-1.5"></th>
                {{ sort_th("Jedn.", "unit") }}
                <th class="px-0 py-1.5"></th>
                {{ sort_th("Vlastník", "owner") }}
                {{ sort_th("Typ", "space_type") }}
                {{ sort_th("Vlastnictví", "ownership") }}
                {{ sort_th("Podíl", "podil", "right") }}
                {{ sort_th("%", "match", "center") }}
                {{ sort_th("Akce", "action") }}
            </tr>
        </thead>
        {% for record in records %}
        {% include "partials/sync_row.html" %}
        {% endfor %}
    </table>
</div>
</form>

<div class="mt-2 text-xs text-gray-400">Zobrazeno: {{ records|length }} záznamů</div>

<script>
function syncToggleAll() {
    var all = document.querySelectorAll('.sync-checkbox');
    var anyUnchecked = Array.from(all).some(function(cb) { return !cb.checked; });
    all.forEach(function(cb) { cb.checked = anyUnchecked; });
    document.querySelectorAll('.sync-row-checkbox').forEach(function(cb) { cb.checked = anyUnchecked; cb.indeterminate = false; });
    syncUpdateCount();
    document.getElementById('sync-toggle-btn').textContent = anyUnchecked ? 'Zrušit výběr' : 'Vybrat vše';
}
function syncToggleRow(rowCb) {
    var recordId = rowCb.dataset.record;
    var tbody = document.getElementById('sync-' + recordId);
    if (!tbody) return;
    tbody.querySelectorAll('.sync-checkbox').forEach(function(cb) {
        cb.checked = rowCb.checked;
    });
    syncUpdateCount();
}
function syncUpdateRowCheckbox(fieldCb) {
    var tbody = fieldCb.closest('tbody');
    if (!tbody) return;
    var rowCb = tbody.querySelector('.sync-row-checkbox');
    if (!rowCb) return;
    var all = tbody.querySelectorAll('.sync-checkbox');
    var checked = tbody.querySelectorAll('.sync-checkbox:checked');
    rowCb.checked = checked.length === all.length;
    rowCb.indeterminate = checked.length > 0 && checked.length < all.length;
}
function syncUpdateCount() {
    var all = document.querySelectorAll('.sync-checkbox');
    var checked = document.querySelectorAll('.sync-checkbox:checked').length;
    var counter = document.getElementById('sync-selected-count');
    var btn = document.getElementById('sync-submit-btn');
    var toggle = document.getElementById('sync-toggle-btn');
    if (counter) counter.textContent = checked + ' polí vybráno';
    if (btn) btn.disabled = checked === 0;
    if (toggle) toggle.textContent = (checked === all.length && all.length > 0) ? 'Zrušit výběr' : 'Vybrat vše';
}
</script>
{% endblock %}
