{% set st = record.status.value %}
{% set bg_class %}{% if st == 'name_order' %}bg-orange-50{% elif st == 'difference' %}bg-red-50{% elif st == 'match' %}bg-green-50{% elif record.resolution.value == 'rejected' %}bg-gray-50{% else %}bg-gray-100{% endif %}{% endset %}
{% set podil_ok = record.excel_podil_scd and record.csv_share and record.excel_podil_scd == record.csv_share %}
{% set podil_diff = record.excel_podil_scd and record.csv_share and record.excel_podil_scd != record.csv_share %}
{% set has_name_diff = record.csv_owner_name and record.excel_owner_name and record.csv_owner_name != record.excel_owner_name %}
{% set has_space_diff = record.csv_space_type and record.excel_space_type and record.csv_space_type != record.excel_space_type %}
{% set has_ownership_diff = record.csv_ownership_type and record.excel_ownership_type and record.csv_ownership_type != record.excel_ownership_type %}
{% set has_any_diff = has_name_diff or has_space_diff or has_ownership_diff or podil_diff %}
<tbody id="sync-{{ record.id }}">
    <tr class="{{ bg_class }} border-b border-gray-100">
        <td class="px-0 py-1 text-center" rowspan="2">
            {% if has_any_diff %}
            <input type="checkbox" class="sync-row-checkbox cursor-pointer" data-record="{{ record.id }}" onchange="syncToggleRow(this)">
            {% endif %}
        </td>
        <td class="px-1 py-1 font-medium text-gray-900" rowspan="2">{{ record.unit_number }}</td>
        <td class="px-0 py-1"><span class="text-blue-600 font-bold">E</span></td>
        {% set back_url = ("/synchronizace/" ~ session.id ~ "?filtr=" ~ filtr) if filtr else ("/synchronizace/" ~ session.id) %}
        {% set owners_list = owner_map[record.unit_number] if (owner_map is defined and record.unit_number in owner_map) else [] %}
        <td class="px-1 py-1 text-gray-800 overflow-hidden" style="text-overflow:ellipsis;white-space:nowrap" title="{{ record.excel_owner_name or '' }}">
            {% if record.admin_corrected_name %}
            <span class="line-through text-gray-300">{{ record.excel_owner_name or '—' }}</span>
            {% for oid, oname in owners_list %}{% if not loop.first %}; {% endif %}<a href="/vlastnici/{{ oid }}?back={{ back_url|urlencode }}" class="text-blue-600 font-medium hover:underline">{{ oname }}</a>{% endfor %}
            {% if not owners_list %}<span class="text-blue-600 font-medium">{{ record.admin_corrected_name }}</span>{% endif %}
            {% elif owners_list %}
            {% for oid, oname in owners_list %}{% if not loop.first %}; {% endif %}<a href="/vlastnici/{{ oid }}?back={{ back_url|urlencode }}" class="hover:underline hover:text-blue-600">{{ oname }}</a>{% endfor %}
            {% else %}
            {{ record.excel_owner_name or '—' }}
            {% endif %}
        </td>
        <td class="px-1 py-1 text-gray-500" style="text-overflow:ellipsis;overflow:hidden;white-space:nowrap" title="{{ record.excel_space_type or '' }}">{{ record.excel_space_type or '—' }}</td>
        <td class="px-1 py-1 text-gray-500">{{ record.excel_ownership_type or '—' }}</td>
        <td class="px-1 py-1 text-gray-800 text-right font-mono whitespace-nowrap">{% if record.excel_podil_scd %}{{ "{:,}".format(record.excel_podil_scd).replace(",", " ") }}{% else %}—{% endif %}</td>
        <td class="px-1 py-1 text-center font-bold whitespace-nowrap {% if st == 'match' %}text-green-600{% elif st == 'name_order' %}text-orange-500{% else %}text-red-500{% endif %}" rowspan="2">{{ record.match_details.split('|')[0].strip() if record.match_details else '' }}</td>
        <td class="px-1 py-1" rowspan="2">
            {% if record.resolution.value == 'manual_edit' %}
            <span class="text-blue-600 cursor-help" {% if record.admin_note %}title="{{ record.admin_note }}"{% endif %}>Upr.</span>
            {% elif st in ('match', 'name_order') or record.resolution.value == 'accepted' %}
            <span class="text-green-600 font-medium">OK</span>
            {% endif %}
        </td>
    </tr>
    <tr class="{{ bg_class }} border-b-2 border-gray-200">
        <td class="px-0 py-1"><span class="text-gray-400 font-bold">C</span></td>
        <td class="px-1 py-1 overflow-hidden {% if st == 'match' %}text-gray-500{% elif st == 'name_order' %}text-orange-600{% else %}text-red-600{% endif %}" style="text-overflow:ellipsis;white-space:nowrap" title="{{ record.csv_owner_name or '' }}">
            {% if has_name_diff %}
            <label class="inline-flex items-center gap-0.5 cursor-pointer"><input type="checkbox" name="update__{{ record.id }}__owner_name" value="{{ record.csv_owner_name }}" class="sync-checkbox" onchange="syncUpdateRowCheckbox(this);syncUpdateCount()"><span>{{ record.csv_owner_name }}</span></label>
            {% else %}{{ record.csv_owner_name or '—' }}{% endif %}
        </td>
        <td class="px-1 py-1 {% if has_space_diff %}text-orange-600{% else %}text-gray-400{% endif %}" style="text-overflow:ellipsis;overflow:hidden;white-space:nowrap">
            {% if has_space_diff %}
            <label class="inline-flex items-center gap-0.5 cursor-pointer"><input type="checkbox" name="update__{{ record.id }}__space_type" value="{{ record.csv_space_type }}" class="sync-checkbox" onchange="syncUpdateRowCheckbox(this);syncUpdateCount()"><span>{{ record.csv_space_type }}</span></label>
            {% else %}{{ record.csv_space_type or '—' }}{% endif %}
        </td>
        <td class="px-1 py-1 {% if has_ownership_diff %}text-orange-600{% else %}text-gray-400{% endif %}">
            {% if has_ownership_diff %}
            <label class="inline-flex items-center gap-0.5 cursor-pointer"><input type="checkbox" name="update__{{ record.id }}__ownership_type" value="{{ record.csv_ownership_type }}" class="sync-checkbox" onchange="syncUpdateRowCheckbox(this);syncUpdateCount()"><span>{{ record.csv_ownership_type }}</span></label>
            {% else %}{{ record.csv_ownership_type or '—' }}{% endif %}
        </td>
        <td class="px-1 py-1 text-right font-mono whitespace-nowrap {% if podil_diff %}text-orange-600 font-bold{% else %}text-gray-400{% endif %}">
            {% if podil_diff %}
            <label class="inline-flex items-center gap-0.5 cursor-pointer"><input type="checkbox" name="update__{{ record.id }}__podil_scd" value="{{ record.csv_share }}" class="sync-checkbox" onchange="syncUpdateRowCheckbox(this);syncUpdateCount()"><span>{{ "{:,}".format(record.csv_share).replace(",", " ") }}</span></label>
            {% elif record.csv_share %}{{ "{:,}".format(record.csv_share).replace(",", " ") }}{% else %}—{% endif %}
        </td>
    </tr>
</tbody>
