{% extends "base.html" %}
{% block title %}Náhled importu - {{ voting.title }} - SVJ Správa{% endblock %}

{% block content %}
<div class="flex flex-col" style="height:calc(100vh - 3rem)">
<div class="shrink-0">
{% include "voting/_voting_header.html" %}

<div class="flex items-center justify-between mb-3">
    <div>
        <h2 class="text-lg font-bold text-gray-800">Náhled importu výsledků</h2>
        <p class="text-xs text-gray-500 mt-0.5">{{ preview.matched|length + preview.unmatched|length }} řádků celkem</p>
    </div>
    <div class="flex items-center gap-2">
        <form action="/hlasovani/{{ voting.id }}/import/potvrdit" method="post">
            <input type="hidden" name="file_path" value="{{ file_path }}">
            <input type="hidden" name="mapping_json" value='{{ mapping_json }}'>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium">
                Zapsat naimportované výsledky
            </button>
        </form>
        <a href="/hlasovani/{{ voting.id }}/import" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm font-medium">
            Zpět
        </a>
        {% if mapping.get('clear_existing') %}
        <span class="ml-2 px-3 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">Režim: vyčistit a přepsat</span>
        {% else %}
        <span class="ml-2 px-3 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Režim: doplnit data</span>
        {% endif %}
    </div>
</div>

<!-- Filter bubbles -->
<div class="flex gap-2 mb-3">
    <a href="#" onclick="filterImport('all');return false"
       class="filter-bubble flex-1 block bg-white rounded-lg shadow p-2 text-center hover:ring-2 hover:ring-gray-300 ring-2 ring-gray-400" data-filter="all">
        <p class="text-lg font-bold text-gray-800">{{ preview.matched|length + preview.unmatched|length }}</p>
        <p class="text-xs text-gray-500">Celkem</p>
    </a>
    <a href="#" onclick="filterImport('matched');return false"
       class="filter-bubble flex-1 block bg-green-50 rounded-lg shadow p-2 text-center border border-green-200 hover:ring-2 hover:ring-green-300" data-filter="matched">
        <p class="text-lg font-bold text-green-600">{{ preview.matched|length }}</p>
        <p class="text-xs text-green-600">Přiřazeno</p>
    </a>
    <a href="#" onclick="filterImport('unmatched');return false"
       class="filter-bubble flex-1 block bg-red-50 rounded-lg shadow p-2 text-center border border-red-200 hover:ring-2 hover:ring-red-300" data-filter="unmatched">
        <p class="text-lg font-bold {% if preview.unmatched %}text-red-600{% else %}text-gray-400{% endif %}">{{ preview.unmatched|length }}</p>
        <p class="text-xs text-red-600">Nepřiřazeno</p>
    </a>
    <a href="#" onclick="filterImport('error');return false"
       class="filter-bubble flex-1 block bg-yellow-50 rounded-lg shadow p-2 text-center border border-yellow-200 hover:ring-2 hover:ring-yellow-300" data-filter="error">
        <p class="text-lg font-bold {% if preview.errors %}text-yellow-600{% else %}text-gray-400{% endif %}">{{ preview.errors|length }}</p>
        <p class="text-xs text-yellow-600">Chyby</p>
    </a>
</div>

<!-- Search -->
<div class="mb-3">
    <input type="text" id="import-search" placeholder="Hledat vlastníka nebo jednotku..."
           class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
</div>
</div>

<!-- Errors -->
{% if preview.errors %}
<div id="errors-section" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-3 hidden">
    <h3 class="text-sm font-semibold text-yellow-800 mb-2">Chyby při zpracování:</h3>
    <ul class="text-sm text-yellow-700 list-disc list-inside">
        {% for error in preview.errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="flex-1 overflow-y-auto min-h-0">
<!-- Preview table -->
<div class="bg-white rounded-lg shadow">
    <table id="preview-table" class="w-full text-xs">
        <thead class="bg-gray-50 border-b-2 border-gray-300 sticky top-0 z-10">
            <tr>
                <th class="px-3 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-blue-600 select-none" onclick="sortImport(0,'num')">Řádek <span class="sort-arrow"></span></th>
                <th class="px-3 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-blue-600 select-none" onclick="sortImport(1,'str')">Vlastník <span class="sort-arrow"></span></th>
                <th class="px-3 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-blue-600 select-none" onclick="sortImport(2,'num')">Jednotka <span class="sort-arrow"></span></th>
                {% for item in voting.items %}
                <th class="px-3 py-2 text-center font-medium text-gray-500 cursor-pointer hover:text-blue-600 select-none" onclick="sortImport({{ 3 + loop.index0 }},'str')">{{ item.order }}. {{ item.title|truncate(20) }} <span class="sort-arrow"></span></th>
                {% endfor %}
                <th class="px-3 py-2 text-center font-medium text-gray-500 cursor-pointer hover:text-blue-600 select-none" onclick="sortImport({{ 3 + voting.items|length }},'str')">Stav <span class="sort-arrow"></span></th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
            {% for entry in preview.matched %}
            <tr class="hover:bg-gray-50 import-row" data-match="matched">
                <td class="px-3 py-1.5 text-gray-400">{{ entry.row }}</td>
                <td class="px-3 py-1.5 font-medium text-gray-900">{{ entry.owner_name }}</td>
                <td class="px-3 py-1.5 text-gray-500">{{ entry.unit_number }}</td>
                {% for item in voting.items %}
                <td class="px-3 py-1.5 text-center">
                    {% if item.id in entry.votes %}
                        {% if entry.votes[item.id].vote == 'for' %}
                        <span class="px-2 py-0.5 text-xs font-medium bg-green-100 text-green-800 rounded-full">PRO {{ entry.votes[item.id].count }}</span>
                        {% elif entry.votes[item.id].vote == 'against' %}
                        <span class="px-2 py-0.5 text-xs font-medium bg-red-100 text-red-800 rounded-full">PROTI {{ entry.votes[item.id].count }}</span>
                        {% endif %}
                    {% else %}
                    <span class="text-gray-300">-</span>
                    {% endif %}
                </td>
                {% endfor %}
                <td class="px-3 py-1.5 text-center">
                    <span class="text-green-600" title="Přiřazeno">&#10003;</span>
                </td>
            </tr>
            {% endfor %}
            {% for entry in preview.unmatched %}
            <tr class="hover:bg-red-50 import-row bg-red-50/50" data-match="unmatched">
                <td class="px-3 py-1.5 text-gray-400">{{ entry.row }}</td>
                <td class="px-3 py-1.5 font-medium text-gray-900">{{ entry.owner_name }}</td>
                <td class="px-3 py-1.5 text-gray-500">{{ entry.unit_number }}</td>
                {% for item in voting.items %}
                <td class="px-3 py-1.5 text-center"><span class="text-gray-300">-</span></td>
                {% endfor %}
                <td class="px-3 py-1.5 text-center" title="{{ entry.reason }}">
                    <span class="text-red-600">&#10007;</span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mt-2 text-xs text-gray-400" id="visible-count">Zobrazeno: {{ preview.matched|length + preview.unmatched|length }} řádků</div>
</div>
</div>

<script>
var activeFilter = 'all';
var searchQuery = '';

function applyFilters() {
    var errSection = document.getElementById('errors-section');
    if (activeFilter === 'error') {
        if (errSection) errSection.classList.remove('hidden');
        document.querySelectorAll('.import-row').forEach(function(r) { r.style.display = 'none'; });
        return;
    }
    if (errSection) errSection.classList.add('hidden');
    var visible = 0;
    var q = searchQuery.toLowerCase();
    document.querySelectorAll('.import-row').forEach(function(r) {
        var matchFilter = activeFilter === 'all' || r.dataset.match === activeFilter;
        var matchSearch = !q || r.textContent.toLowerCase().indexOf(q) !== -1;
        var show = matchFilter && matchSearch;
        r.style.display = show ? '' : 'none';
        if (show) visible++;
    });
    document.getElementById('visible-count').textContent = 'Zobrazeno: ' + visible + ' řádků';
}

function filterImport(type) {
    activeFilter = type;
    applyFilters();
    document.querySelectorAll('.filter-bubble').forEach(function(b) {
        b.classList.remove('ring-2', 'ring-gray-400', 'ring-green-400', 'ring-red-400', 'ring-yellow-400');
        if (b.dataset.filter === type) {
            b.classList.add('ring-2');
            if (type === 'all') b.classList.add('ring-gray-400');
            else if (type === 'matched') b.classList.add('ring-green-400');
            else if (type === 'unmatched') b.classList.add('ring-red-400');
            else if (type === 'error') b.classList.add('ring-yellow-400');
        }
    });
}

// Search
var searchTimer;
document.getElementById('import-search').addEventListener('keyup', function() {
    clearTimeout(searchTimer);
    var input = this;
    searchTimer = setTimeout(function() {
        searchQuery = input.value;
        applyFilters();
    }, 300);
});

// Sort
var importSortCol = -1, importSortAsc = true;
function sortImport(col, type) {
    var table = document.getElementById('preview-table');
    var tbody = table.querySelector('tbody');
    var rows = Array.from(tbody.querySelectorAll('tr'));
    if (importSortCol === col) { importSortAsc = !importSortAsc; } else { importSortCol = col; importSortAsc = true; }
    rows.sort(function(a, b) {
        var aCell = a.cells[col], bCell = b.cells[col];
        var aText = (aCell.dataset.sort || aCell.textContent).trim();
        var bText = (bCell.dataset.sort || bCell.textContent).trim();
        if (type === 'num') {
            var aNum = parseInt(aText.replace(/\s/g, '')) || 0;
            var bNum = parseInt(bText.replace(/\s/g, '')) || 0;
            return importSortAsc ? aNum - bNum : bNum - aNum;
        }
        return importSortAsc ? aText.localeCompare(bText, 'cs') : bText.localeCompare(aText, 'cs');
    });
    rows.forEach(function(row) { tbody.appendChild(row); });
    table.querySelectorAll('.sort-arrow').forEach(function(s) { s.textContent = ''; });
    var arrow = table.querySelectorAll('thead th')[col].querySelector('.sort-arrow');
    if (arrow) arrow.textContent = importSortAsc ? ' \u25B2' : ' \u25BC';
    table.querySelectorAll('thead th').forEach(function(th, i) {
        th.classList.toggle('text-blue-600', i === col);
        th.classList.toggle('text-gray-500', i !== col);
    });
}
</script>
{% endblock %}
