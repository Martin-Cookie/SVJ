{% extends "base.html" %}
{% block title %}Lístek - {{ ballot.owner.display_name }} - SVJ Správa{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="/hlasovani/{{ voting.id }}/listky" class="text-sm text-gray-500 hover:text-gray-700">&larr; Zpět na hlasovací lístky</a>
</div>

<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-800">Hlasovací lístek</h1>
        <p class="text-sm text-gray-500 mt-1">{{ voting.title }}</p>
    </div>
    {% if ballot.status.value == 'generated' %}
    <span class="px-3 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">Vygenerován</span>
    {% elif ballot.status.value == 'sent' %}
    <span class="px-3 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Odeslán</span>
    {% elif ballot.status.value == 'received' %}
    <span class="px-3 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Přijat</span>
    {% elif ballot.status.value == 'processed' %}
    <span class="px-3 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Zpracován</span>
    {% endif %}
</div>

<!-- Owner info -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div>
            <p class="text-xs text-gray-500">Vlastník</p>
            <p class="text-sm font-medium"><a href="/vlastnici/{{ ballot.owner.id }}?back={{ ('/hlasovani/' ~ voting.id ~ '/listek/' ~ ballot.id)|urlencode }}" class="text-blue-600 hover:underline">{{ ballot.owner.display_name }}</a></p>
        </div>
        <div>
            <p class="text-xs text-gray-500">Jednotky</p>
            <p class="text-sm text-gray-800">{{ ballot.units_text or '—' }}</p>
        </div>
        <div>
            <p class="text-xs text-gray-500">Počet hlasů</p>
            <p class="text-sm font-medium text-gray-800">{{ "{:,}".format(ballot.total_votes).replace(",", " ") }}</p>
        </div>
        <div>
            <p class="text-xs text-gray-500">Plná moc</p>
            <p class="text-sm text-gray-800">{% if ballot.voted_by_proxy %}{{ ballot.proxy_holder_name }}{% else %}—{% endif %}</p>
        </div>
    </div>
</div>

<!-- Votes or processing form -->
<div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-4">Body hlasování</h2>

    {% if ballot.status.value == 'processed' %}
    <table class="w-full text-sm">
        <thead class="border-b border-gray-200">
            <tr>
                <th class="px-3 py-2 text-left font-medium text-gray-500">Bod</th>
                <th class="px-3 py-2 text-left font-medium text-gray-500">Hlas</th>
                <th class="px-3 py-2 text-right font-medium text-gray-500">Hlasů</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
            {% for bv in ballot.votes | sort(attribute='voting_item.order') %}
            <tr>
                <td class="px-3 py-2">
                    <span class="font-medium">{{ bv.voting_item.order }}.</span> {{ bv.voting_item.title }}
                </td>
                <td class="px-3 py-2">
                    {% if bv.vote and bv.vote.value == 'for' %}
                    <span class="px-2 py-0.5 text-xs font-medium bg-green-100 text-green-800 rounded-full">PRO</span>
                    {% elif bv.vote and bv.vote.value == 'against' %}
                    <span class="px-2 py-0.5 text-xs font-medium bg-red-100 text-red-800 rounded-full">PROTI</span>
                    {% elif bv.vote and bv.vote.value == 'abstain' %}
                    <span class="px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">Zdržel se</span>
                    {% else %}
                    <span class="text-gray-400">—</span>
                    {% endif %}
                </td>
                <td class="px-3 py-2 text-right font-mono text-gray-600">{{ "{:,}".format(bv.votes_count).replace(",", " ") }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if ballot.processed_at %}
    <p class="mt-4 text-xs text-gray-400">Zpracováno {{ ballot.processed_at.strftime('%d.%m.%Y %H:%M') }}</p>
    {% endif %}

    {% else %}
    <form action="/hlasovani/{{ voting.id }}/zpracovat/{{ ballot.id }}" method="post" hx-boost="false">
        <div class="space-y-3">
            {% for item in voting.items %}
            <div class="flex items-center justify-between py-2 border-b border-gray-100">
                <span class="text-sm text-gray-700">
                    <strong>{{ item.order }}.</strong> {{ item.title }}
                </span>
                <div class="flex gap-4">
                    <label class="flex items-center gap-1.5 cursor-pointer">
                        <input type="radio" name="vote_{{ item.id }}" value="for" class="text-green-600 focus:ring-green-500">
                        <span class="text-sm text-green-700">PRO</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer">
                        <input type="radio" name="vote_{{ item.id }}" value="against" class="text-red-600 focus:ring-red-500">
                        <span class="text-sm text-red-700">PROTI</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer">
                        <input type="radio" name="vote_{{ item.id }}" value="abstain" class="text-gray-600 focus:ring-gray-500">
                        <span class="text-sm text-gray-500">Zdržel se</span>
                    </label>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="mt-4">
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium">
                Potvrdit zpracování
            </button>
        </div>
    </form>
    {% endif %}
</div>
{% endblock %}
